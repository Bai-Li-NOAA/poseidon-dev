---
title: "Testing atlantisom: fishery catch data tests"
author: "Sarah Gaichas and Christine Stawitz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: "packages.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'knitr', 'rmarkdown', 'tidyr', 'dplyr', 'ggplot2',
  'data.table', 'here', 'ggforce', 'ggthemes'
), 'packages.bib')
```

## Introduction

Fishery sampling functions in atlantisom have not yet been extensively tested. There is also a problem with the CATCH.nc output for models in codebases prior to 2015 (inclucing CCA). Here we first test with NOBA which should not have this output bug, then we will revisit CCA with a fix to `read_truth` to compensate for the catch output problem (see [this](https://sgaichas.github.io/poseidon-dev/Atlantisom2SSworkflowtest.html)). 

For all setup, etc, please see previous files. Full methods are explained [here](https://sgaichas.github.io/poseidon-dev/TrueBioTest.html) and  [here](https://sgaichas.github.io/poseidon-dev/TrueLengthCompTest.html).

This page has visualizations for the NOBA model example, CERES Global Sustainability. At the end of the file we also review saved outputs from the CCA model example, Atlantis Summit Common Scenario 1.  

```{r message=FALSE, warning=FALSE}
library(tidyr)
require(dplyr)
library(ggplot2)
library(data.table)
library(here)
library(ggforce)
library(ggthemes)
library(atlantisom)
```

```{r initialize}

initCCA <- FALSE
initNEUS <- FALSE
initNOBA <- TRUE

if(initCCA) source(here("config/CCConfig.R"))

if(initNEUS) source(here("config/NEUSConfig.R"))

if(initNOBA) source(here("config/NOBAConfig.R"))

```

```{r get_names, message=FALSE, warning=FALSE}
#Load functional groups
funct.groups <- load_fgs(dir=d.name,
                         file_fgs = functional.groups.file)
#Get just the names of active functional groups
funct.group.names <- funct.groups %>% 
  filter(IsTurnedOn == 1) %>%
  select(Name) %>%
  .$Name

```

We need to re-`run_truth` for NOBA to include the catchbio component:

```{r load_Rdata, message=FALSE, warning=FALSE}

# default run_truth setup will save the file, so check for that first

if(!file.exists(file.path(d.name, 
                          paste0("output", scenario.name, "run_truth.RData")))){
  #Store all loaded results into an R object
  truth <- run_truth(scenario = scenario.name,
                     dir = d.name,
                     file_fgs = functional.groups.file,
                     file_bgm = box.file,
                     select_groups = funct.group.names,
                     file_init = initial.conditions.file,
                     file_biolprm = biol.prm.file,
                     file_runprm = run.prm.file
  )
} else{
  truth <- get(load(file.path(d.name,
                              paste0("output", scenario.name, "run_truth.RData"))))
}

```

## Testing fisheries functions

We will apply examples here to just a few NOBA species to speed things up:
    - Cod "North_atl_cod", likely a test assessment species
    - Herring "Norwegian_ssh", likely a test assessment species
    - Greenland halibut "Green_halibut", which grows to a large size.

To create a census, the user specifies the timing of the survey, which species are captured, the spatial coverage of the survey, the species-specific survey efficiency ("q"), and the selectivity at age for each species. The following settings should achieve a survey that samples all Atlantis model output timesteps, all fish and shark species, and all model polygons, with perfect efficiency and full selectivity for all ages.


```{r census-spec, message=FALSE, warning=FALSE}

source(here("config/census_spec.R"))

```

# Test fishery functions: compare census with truth

Now for the fishery outputs. We will need total catch in tons for each species, and catch composition data (age and length). First we will test whether the catchbio output in `truth` matches the atlantis output file output[scenario.name]Catch.txt:

```{r testcatchbio1}

#just try the three species for now, hardcoded for NOBA

spp.name <- funct.group.names[funct.group.names %in% c("North_atl_cod",
                                                       "Norwegian_ssh",
                                                       "Green_halibut")]

catchbio_census_ss <- create_fishery_subset(dat = truth$catchbio,
                                         time = timeall,
                                         species = spp.name,
                                         boxes = boxall)

catchbio_census_ss_agg <- aggregate(atoutput ~ species + time,
                                    data=catchbio_census_ss, sum)

# what does the output look like?
catchB_outstep <- ggplot() +
  geom_line(data=catchbio_census_ss_agg, aes(x=time/fstepperyr,y=atoutput, color="catch atlantisom"),
            alpha = 10/10) +
  theme_tufte() +
  theme(legend.position = "top") +
  labs(colour=scenario.name)

catchB_outstep + 
  facet_wrap(~species, scales="free") 


```


```{r testcatchbio2}

# should it be aggregated? I just did this above
catchbio_series <- sample_survey_numbers(catchbio_census_ss, surv_cv)

# if it is the pre-2015 bug mentioned in atlantis wiki, this may get it close
# should not need for NOBA
#catchbio_series_adjust <- catchbio_series %>%
#  mutate(atoutput = atoutput/(86400*4))

#does it match catch.txt (which should be in tons)?
atCtxt <- read.table(file.path(d.name, catch.file), header=T)
atCtxt <- atCtxt[, -grep("TsAct", colnames(atCtxt))] #hardcoded for catch.txt output 

fishedlookup <- funct.groups %>%
  filter(IsFished > 0)

atCtxttidy <- atCtxt %>%
  rename_(.dots=with(fishedlookup, setNames(as.list(as.character(Code)), Name))) %>%
  gather(species, catchbio, -Time) %>%
  filter(species %in% levels(catchbio_series$species))

compare_catchB <-ggplot() +
  geom_line(data=catchbio_series, aes(x=time,y=atoutput, color="catch atlantisom"), 
            alpha = 10/10) +
  geom_point(data=atCtxttidy, aes(x=Time/365,y=catchbio, color="txt output catch bio"),
             alpha = 1/10) + 
  theme_tufte() +
  theme(legend.position = "top") +
  labs(colour=scenario.name)

compare_catchB + 
  facet_wrap(~species, scales="free") 

```


Did it work for NOBA?

Now test catch at age in numbers from truth$catch

## Modify below to test biological sampling from fisheries

Here we use `create_survey` on the numbers output of `run_truth` to create the survey census of age composition (for just one species in this case). The `sample_fish` applies the median for aggregation and does not apply multinomial sampling if `sample=FALSE` in the function call. 

Because we don't want to wait 24 hours for this, we will look at only the first 112 time steps.

```{r catchage-len-wt-3spp, echo=TRUE}

# get survey nums with full (no) selectivity
catch_testNss <- create_fishery_subset(dat = truth$catch,
                                 time = c(0:111),
                                 species = spp.name,
                                 boxes = boxall)

# apply default sample fish as before to get numbers
catch_numssshigh <- sample_fish(catch_testNss, effNhigh)


# aggregate true resn per survey or fishery subset design
catch_aggresnss <- aggregateDensityData(dat = truth$resn,
                                 time = c(0:111),
                                 species = spp.name,
                                 boxes = boxall)

# aggregate true structn per survey or fishery subsetdesign
catch_aggstructnss <- aggregateDensityData(dat = truth$structn,
                                 time = c(0:111),
                                 species = spp.name,
                                 boxes = boxall)

#dont sample these, just aggregate them using median
catch_structnss <- sample_fish(catch_aggstructnss, effNhigh, sample = FALSE)

catch_resnss <-  sample_fish(catch_aggresnss, effNhigh, sample = FALSE)

```

Length sample with user specified max length bin (200 cm):

```{r userset-maxlen, echo=TRUE}

catch_length_census_ss <- calc_age2length(structn = catch_structnss,
                                 resn = catch_resnss,
                                 nums = catch_numssshigh,
                                 biolprm = truth$biolprm, fgs = truth$fgs,
                                 maxbin = 200,
                                 CVlenage = 0.1, remove.zeroes=TRUE)


```

We should get the upper end of Greenland halibut with a 200cm max length bin. That shouldnt matter for weight at age. This is all timesteps for each species by agecl.

```{r vis-wtageclass-test}

wageplot <- ggplot(length_census$muweight, aes(agecl, atoutput)) +
  geom_point(aes(colour = time)) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  scale_x_discrete(limits=c(1:10)) +
  xlab("age class") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste(scenario.name))

wageplot + facet_wrap(c("species"), scales="free_y")

```

How much does weight at age class vary over time? Here are a couple of annual cycles:

```{r vis-wtageclass-test2}

wtageyr1 <- length_census$muweight %>%
  filter(time<5)

wageplot <- ggplot(wtageyr1, aes(agecl, atoutput)) +
  geom_line(aes(colour = factor(time))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  scale_x_discrete(limits=c(1:10)) +
  xlab("age class") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " initial year"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

```{r vis-wtageclass-test3}

wtageyrmid <- length_census$muweight %>%
  filter(between(time, 50,54))

wageplot <- ggplot(wtageyrmid, aes(agecl, atoutput)) +
  geom_line(aes(colour = factor(time))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  scale_x_discrete(limits=c(1:10)) +
  xlab("age class") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " year 10"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

```{r vis-wtageclass-test4}

wtageyr20 <- length_census$muweight %>%
  filter(between(time, 100,104))

wageplot <- ggplot(wtageyr20, aes(agecl, atoutput)) +
  geom_line(aes(colour = factor(time))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  scale_x_discrete(limits=c(1:10)) +
  xlab("age class") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " year 20"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

There are some interesting jumps between age classes. Most pronounced for herring. All of these species would be split into two true ages per age class. Interpolation could be interesting.

Change in wt at age over time for age classes using an annual mid-year snapshot (survey) (first 22+ years of NOBA model run):

```{r aggwtcomp}

# from std survey code and model step info read in above
midptyr <- round(median(seq(1,stepperyr)))
annualmidyear <- seq(midptyr, noutsteps, stepperyr)

wtage_annsurv <- length_census$muweight %>%
  filter(time %in% annualmidyear)

# reverse to show agecl time series of wt
wageplot <- ggplot(wtage_annsurv, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (5 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")

```


## Quick test with saved CCA census output

Here we check the CCA model (Atlantis Summit Common Scenario 1) saved length and weight census output for small species at Isaac's suggestion (all three of the following are true age classes, NumAgeClassSize=1 per Atlantis agecl bin:

```{r loadCCAlengthcomp, echo=TRUE}

source(here("config/CCConfig.R"))

length_censussurvsamp <- readRDS(file.path(d.name, paste0(scenario.name, "length_censussurvsamp.rds")))

```

Sardine:  
```{r plotCCAsardine}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Pacific_sardine")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Anchovy:  
```{r plotCCAanchovy}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Anchovy")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Herring:  
```{r plotCCAherring}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Herring")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

How do these three look? Herring had a rough period from model years 15-30 or so.

Now for some CCA groups with multiple true ages per stage.

Pacific hake, 2 true ages per class:  
```{r plotCCAhake}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Mesopel_M_Fish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Bocaccio rockfish, 5 true ages per age class:
```{r plotCCAbocaccio}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Bocaccio_rockfish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Yelloweye rockfish, most extreme at 12 true ages per age class:
```{r plotCCAYelloweye}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Yelloweye_rockfish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

I'm not sure any of this helps us decide how to interpolate, but there is clearly contrast in weight at age (class) in both models and example runs.