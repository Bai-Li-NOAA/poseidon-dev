---
title: "Interpolate the weight at agecl output to annual age"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(atlantisom)
library(ggthemes)

```

## Start with saved wrapper weight at age output for NOBA cod

```{r full-test, message=FALSE, warning=FALSE}

source(here("config/NOBA2Config.R"))
NOBAom_cod <- readRDS(file.path(d.name, paste0(scenario.name, "omlist_ss.rds")))

fgs <- NOBAom_cod$funct.group_ss
biolprm <- NOBAom_cod$biol

wtage <- readRDS(file.path(d.name, paste0(scenario.name, "survObsWtAtAge.rds")))
wtage <- wtage[[1]]

wageplot <- ggplot(wtage, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (5 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year sample"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

If we were to do simple interpolation on this output, we can approximate weight at true age class:

```{r interpolate-wtage}
# a function to go into atlantisom, sketched here, reuse calc_stage2age as possible

wtagecl <- wtage
annages <- NOBAom_cod$truenumsage_ss %>%
  group_by(species, time, agecl) %>%
  rename(trueage = agecl) %>%
  summarise(truenatage = sum(atoutput))
  
calc_wtTrueage <- function(wtagecl, annages, fgs) {
  # get number of ages per agecl from fgs.file
  #fgs <- atlantisom::load_fgs(dir=d.name, file_fgs = functional.groups.file)
  species.code <- fgs$Code
  #turnedon <- fgs[fgs$IsTurnedOn > 0, ]

  # Figure out the groups that have multiple ages classes in each stage (or
  # cohort) this is from the full model
  multiple_ages <- fgs[fgs$NumAgeClassSize>1, c(1,4,10)]
  
  # match species in wtagecl_data to those species in the fgs file
  sppwt <- levels(wtagecl$species)
  multiple_ages <- multiple_ages[multiple_ages$Name %in% sppwt, ]
  
  #now get indices
  names <- multiple_ages$Code
  num_multi_age <- dim(multiple_ages)[1]

  # timesteps from input wt file
  ntimesteps <- length(unique(wtagecl$time))

  # make a dataframe the right dimensions for all age classes
  # has species, time from wtage and trueage, truenatage from annages
  # add agecl column
  # finds the average age of each agecl each timestep based on truenatage
  wtage_out <- annages %>%
    dplyr::semi_join(wtagecl, by = c("species", "time")) %>%
    dplyr::left_join(multiple_ages, by = c("species" = "Name")) %>%
    dplyr::mutate(agecl = as.integer(ceiling(trueage/NumAgeClassSize))) %>%
    dplyr::group_by(species, time, agecl) %>%
    dplyr::mutate(avgage = weighted.mean(trueage, truenatage))
   
  
  # find weight increment for a timestep
  # muweight for agecl+1 - muweight for agecl
  wtagecl_inc <- wtagecl %>%
    dplyr::arrange(species, time, agecl) %>%
    dplyr::left_join(multiple_ages, by = c("species" = "Name")) %>%
    dplyr::group_by(species, time) %>%
    dplyr::mutate(increment = case_when(
      agecl==1 ~ atoutput,
      agecl>1 ~ atoutput - dplyr::lag(atoutput)
      )) %>%
    dplyr::mutate(agewtinc = increment/NumAgeClassSize)
  
  # last line above does this: divide weight increment by number of ages per agecl 
  # definitely wrong, especially at younger ages, for two reasons:
  #  - assumes each agecl has equal numbers of its constituent ages
  #  - assumes linear growth between age classes
  # (could decay with increasing age, but how different from equal increment?)
  # avgWtAge for agecl 1 = (n age1 * avgwt age1) + (n age2 * avgwt age2)
  

  # recursive: add increment to agecl until hitting agecl+1

  # reunumber agecl 1 to 10*number of ages per agecl

  # output full set of muweight at newly created agecl

}
```

Plot interpolated results for NOBA species:

```{r interp-wtage-test1}

```


## Quick test with saved CCA census output

Here we check the CCA model (Atlantis Summit Common Scenario 1) saved length and weight census output for small species at Isaac's suggestion (all three of the following are true age classes, NumAgeClassSize=1 per Atlantis agecl bin:

```{r loadCCAlengthcomp, echo=TRUE}

source(here("config/CCConfig.R"))

length_censussurvsamp <- readRDS(file.path(d.name, paste0(scenario.name, "length_censussurvsamp.rds")))

```

```{r apply-inter-pwtage-CCA}

```

Plots for species with 1 true age per agecl should not be different:

Sardine:  
```{r plotCCAsardine}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Pacific_sardine")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Anchovy:  
```{r plotCCAanchovy}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Anchovy")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Herring:  
```{r plotCCAherring}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Herring")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

How do these three look? Identical I hope.

Now for some CCA groups with multiple true ages interpolated per stage.

Pacific hake, 2 true ages per class (20 total):  
```{r plotCCAhake}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Mesopel_M_Fish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Bocaccio rockfish, 5 true ages per age class (50 total):
```{r plotCCAbocaccio}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Bocaccio_rockfish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Yelloweye rockfish, most extreme at 12 true ages per age class (120 total):
```{r plotCCAYelloweye}
censuswt <- length_censussurvsamp$muweight %>%
  filter(species == "Yelloweye_rockfish")

wageplot <- ggplot(censuswt, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (1 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year survey"))

wageplot + facet_wrap(c("species"), scales="free_y")
```

Yelloweye should be a good test...