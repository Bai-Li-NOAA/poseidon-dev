---
title: "WritingSSfiles"
author: "Christine Stawitz"
date: "May 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
require(here)
require(reshape2)
require(dplyr)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/chris/Documents/GitHub/atlantisom/")
```

## Introduction

This page discusses reading in an existing stock assessment file and replacing the data values with those from the `atlantisom` package. To read in the Stock Synthesis files, first ensure you have the latest version of `r4ss`

```{r packages, eval=FALSE}
devtools::install_github("r4ss/r4ss", dependencies = FALSE)
```

## Sardine example

Dummy files are in the package directory; use `r4ss` to load the dummy data file

```{r readdata, echo=FALSE}
require(r4ss)
#Read in sardine data file
sardine.data <- r4ss::SS_readdat_3.30("./inst/extdata/Sardine_SS_files/sardEM_3_3.dat")
```

Below, we can see the structure of the catch and CPUE data
```{r}
names(sardine.data$catch) <- names(sardine.data$CPUE)

sardine.data$CPUE
```

We can next look at age composition data
```{r}
sardine.data$agecomp

sardine.data$lencomp
```

We may also need to access or modify the setup variables before the data matrices.

```{r}
#CPUE units, SD and error structure
sardine.data$CPUEinfo

#Number of length bins
sardine.data$N_lbins

#Length bin method
sardine.data$Lbin_method

#Vector of age bins
sardine.data$agebin_vector

```

## Writing index data
To edit index data, use the `atlantisom` sampling functions to extract survey biomass and numbers. These can then be written using the `SS_write_CPUE` function.

```{r}
results <- get(load("outputCCV3run_truth.RData"))
devtools::load_all()
species=c("Pacific_sardine")

#Sample all boxes
boxes <- unique(results$nums$polygon)

#Efficiency of the survey
effic <- data.frame(species=species, efficiency=0.5)

# Assume uniform selectivity
sel<- data.frame(species=rep(species,10),
               agecl=c(1:10),
              selex=rep(1,10))

#Sample survey - 3rd timestep simulates a summer survey
survey_out <- create_survey(dat=results$nums, time=seq(3,495,by=5), species=species, boxes=boxes, effic=effic, selex=sel)

#Set effective sample size for age compositions
effN <- 1000
highEffN <- data.frame(species=species, effN=rep(effN, length(species)))

#Sample fish for age composition
age_comp_data <- sample_fish(survey_out, highEffN)

# aggregate true resn per survey design
survey_aggresnstd <- aggregateDensityData(dat = results$resn,
                                          time = unique(results$nums$time),
                                          species = species,
                                          boxes = boxes)

# aggregate true structn per survey design
survey_aggstructnstd <- aggregateDensityData(dat = results$structn,
                                             time = unique(results$nums$time),
                                             species = species,
                                             boxes = boxes)

ss_structnstd <- sample_fish(survey_aggstructnstd,
                             effN,
                             sample=FALSE)
ss_resnstd <- sample_fish(survey_aggresnstd,
                          effN,
                          sample=FALSE)

#Extract length composition data
ss_length_stdsurv <- calc_age2length(structn = ss_structnstd,
                                     resn = ss_resnstd,
                                     nums = age_comp_data,
                                     biolprm = results$biolprm, fgs = results$fgs,
                                     CVlenage = 0.1, remove.zeroes=TRUE)

#Need to replace with interp function
wtAtAge <- ss_length_stdsurv$muweight %>%
  select(species, agecl, time, wtAtAge = atoutput) %>%
  mutate(wtAtAge = wtAtAge/1000)

# CV function
cv <- data.frame(species="Pacific_sardine", cv=0.1)

#Sample survey biomass
survObsBiom <- sample_survey_biomass(dat=survey_out,cv=cv,wtAtAge)



```


## Catch data

```{r}
sardine.catch <-  create_fishery_subset(dat = results$catch,
                                         time = seq(1,99,by=1),
                                         species = species,
                                         boxes = boxes)

#Sample catch in numbers
sardine.catch.total <- sardine.catch %>%
  group_by(time) %>%
  summarise(catch=sum(atoutput))

nyears <- 50
burnin <- 30
fish_years <- burnin:(burnin+nyears-1)
survey_years <- seq(3,495,by=5)[burnin:(burnin+nyears-1)]

#Test writing CPUE in biomass
  sardine.data <- SS_write_ts(ss_data_list = sardine.data,
                ts_data = list(survObsBiom$atoutput[fish_years],
                  sardine.catch.total$catch[fish_years]),
                CVs = c(0.1,0.1),
                data_years = list((survObsBiom$time[fish_years]-3)/5+1,             sardine.catch.total$time[fish_years]),
            sampling_month = list(rep(7,nyears),
                                rep(1,nyears)),
                units = c("biomass","numbers"),
                data_type=c("CPUE","catch"),
                fleets = c(2,1))

```

## Writing age composition data 

```{r}
age_comp_data

#Get the age bins
age_bin_names <- names(sardine.data$agecomp)[10:length(names(sardine.data$agecomp))]
age_bins <- sub("a","",age_bin_names)

age_comp_flat <- reformat_compositions(age_comp_data,
                     round.places = 4,
                     comp_type = "agecomp")

## Write age composition data for survey
sardine.data <- SS_write_comps(ss_data_list = sardine.data,
               comp_matrix = list(age_comp_flat[burnin:(burnin+nyears-1),]),
               data_rows = list(sardine.data$styr:(sardine.data$styr+nyears-1)),
               sampling_month = list(rep(7,nyears)),
               data_type = c("agecomp"),
               fleet_number = c(1),
               bins = list(age_bins),
               caal_bool = c(FALSE))
sardine.data$agecomp

#We end up using CAAL for the survey below, so let's generate fishery age comps instead
effN <- data.frame(species="Pacific_sardine", effN=effN)

catch_numssshigh <- sample_fish(sardine.catch, effN)

#Get weights
# aggregate true resn per survey or fishery subset design
catch_aggresnss <- aggregateDensityData(dat = results$resn,
                                 time = c(0:111),
                                 species = species,
                                 boxes = boxes)

# aggregate true structn per survey or fishery subsetdesign
catch_aggstructnss <- aggregateDensityData(dat = results$structn,
                                 time = c(0:111),
                                 species = species,
                                 boxes = boxes)

#dont sample these, just aggregate them using median
catch_structnss <- sample_fish(catch_aggstructnss, effN, sample = FALSE)

catch_resnss <-  sample_fish(catch_aggresnss, effN, sample = FALSE)

str(catch_numssshigh)

catch_length <- calc_age2length(structn = catch_structnss,
                                 resn = catch_resnss,
                                 nums = catch_numssshigh,
                                 biolprm = results$biolprm, fgs = results$fgs,
                                 maxbin = 200,
                                 CVlenage = 0.1, remove.zeroes=TRUE)

```


## Setting up sardine EM
For the sardine EM, we want conditional age-at-length (CAAL) and length composition data only. So we use the same function with our matrices of length and CAAL comp data to write to the data file.

```{r}

#Check length compositions match age compositions
ss_length_stdsurv$natlength %>%
  group_by(time,agecl) %>%
  summarise(sum(atoutput))

len_comp_data <- ss_length_stdsurv$natlength
fish_len_comp_data <- catch_length$natlength

```

Once we have the natlength matrix, we can munge the data into the proper CAAL and length bin format for SS


```{r}

caal_comp_flat <- reformat_compositions(len_comp_data,                                round.places=4,
                comp_type="caalcomp")


#remove burnin
caal_comp_final <- filter(caal_comp_flat,
                         time %in% survey_years)


#Add over age classes to get sample size
len_comp_flat <- reformat_compositions(len_comp_data,
                                  round.places = 0,
                           comp_type="lencomp")
#remove burnin
len_comp_final <- filter(len_comp_flat,
                         time %in% survey_years)

length_bins <- as.integer(names(len_comp_final))
length_bins <- length_bins[!is.na(length_bins)]

fish_len_comp_flat <- reformat_compositions(catch_length$natlength,
                                  round.places = 0,
                           comp_type="lencomp")
#remove burnin
fish_len_comp_final <- filter(fish_len_comp_flat,
                         time %in% fish_years)

fish_age_comp_flat <- reformat_compositions(catch_numssshigh,
                           comp_type="agecomp")
#remove burnin
fish_age_comp_final <- filter(fish_age_comp_flat,
                         time %in% fish_years)

comp_list <- list(caal_comp_final,len_comp_final,          fish_age_comp_final, fish_len_comp_final)

apply_month <- list(rep(7, nrow(comp_list[[1]])), rep(7, nrow(comp_list[[2]])), rep(1,nrow(comp_list[[3]])),rep(1,nrow(comp_list[[4]])))

# Write CAAL and length composition data
sardine.data <- SS_write_comps(ss_data_list = sardine.data, comp_matrix = comp_list, data_rows = list((comp_list[[1]]$time-3)/5 + 1 ,(survey_years-3)/5 + 1,fish_years,fish_years),
        sampling_month = apply_month, data_type = rep(c("agecomp", "lencomp"),2), fleet_number = c(2,2,1,1),  bins = list(age_bins, length_bins, age_bins, length_bins), caal_bool = c(TRUE, rep(FALSE,3)))

head(sardine.data$lencomp)
head(sardine.data$agecomp)

#Change length bin structure to match atlantis data
sardine.data$lbin_vector <- length_bins

#Set lbin_method to 1 - this makes the population length bins match the data bins 
#When lbin_method==1, we just comment out the binwidth, minimum, and maximum size arguments since they aren't used
sardine.data$lbin_method <- 1
sardine.data$binwidth <- "#"
sardine.data$minimum_size <- "#"
sardine.data$maximum_size <- "#"

#Change minimum sample size to 0.001 for CAAL data (SS won't let it go lower than this)
sardine.data$age_info$minsamplesize <- rep(0.001,2)

SS_writedat_3.30(sardine.data, outfile = "./inst/extdata/Sardine_SS_files/sardEM_3_3.dat",
                 overwrite=TRUE)
```

## Coming up with dynamic life history parameters

Below we get the weight-length relationship parameters from atlantis, calculate h and R0 from Atlantis $\alpha$ and $\beta$ parameters, use the \code{calc_Z} function to back out natural mortality (M) from Atlantis, and use the survey length-at-age from Atlantis to estimate a growth curve.
```{r}
#Get biological parameters
biolprm <- results$biolprm
fgs <- results$fgs
li_a_use <- biolprm$wl[match(fgs$Code[match(species,fgs$Name)],biolprm$wl[, 1]), 2]/1000
li_b_use <- biolprm$wl[match(fgs$Code[match(species,fgs$Name)],biolprm$wl[, 1]), 3]

```

