---
title: "Generate data for multispecies modeling, including diet!"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)  
library(atlantisom)
library(ggthemes)

```

## Which species?

Let's use the wrapper functions to get initial multispecies assessment model inputs.

We use config files for the NOBA model, and define multispecies surveys and fisheries. We will also test diet functions which are needed as multispecies and ecosystem model inputs. 

Our initial species selection includes 11 single species groups from the NOBA model:

```{r spp-table}

fgs <- load_fgs(here("atlantisoutput", "NOBA_March_2020"), "nordic_groups_v04.csv")

lname <- data.frame(Latin = c("*Hippoglossoides platessoides*",
                              "*Reinhardtius hippoglossoides*",
                              "*Scomber scombrus*",
                              "*Melongrammus aeglefinus*",
                              "*Pollachius virens*",
                              "*Sebastes mentella*",
                              "*Micromesistius poutassou*",
                              "*Clupea harengus*",
                              "*Gadus morhua*",
                              "*Boreogadus saida*",
                              "*Mallotus villosus*"),
                    Code = c("LRD", "GRH", "MAC", "HAD", "SAI", "RED", 
                             "BWH", "SSH", "NCO", "PCO", "CAP")
)

sppsubset <- merge(fgs, lname, all.y = TRUE)
spptable <- sppsubset %>% 
  arrange(Index) %>%
  select(Name, Long.Name, Latin)

knitr::kable(spptable, col.names = c("Model name", "Full name", "Latin name"))

```

These represent a range of life histories which are similar to those on the Northeast US shelf (some are the same species), so they form a reasonable set of species for multispecies model testing.

### Diet interactions

How much do these species interact with each other? Now we test the diet composition functions in `atlantisom`.

Diet composition is loaded with `load_diet_comp()`:

```{r loaddiet}

diettest <- load_diet_comp(here("atlantisoutput", "NOBA_march_2020"), 
                           "nordic_runresults_01DietCheck.txt", fgs = fgs)

ms_diet <- diettest %>%
  filter(species %in% sppsubset$Name) %>%
  filter(atoutput>0)


```

### Plotting diets {.tabset}

```{r plotdietcomp}

plist = lapply(split(ms_diet, ms_diet$species), function(d) {
  ggplot(d, aes(time.days/365, atoutput, fill=prey)) + 
    geom_bar(stat = "identity") +
    facet_wrap(species~agecl) +
    xlab("year") +
    ylab("diet proportion") +
    theme_tufte() +
    theme(legend.position="bottom")
})

```

#### Capelin
```{r}
plist$Capelin
```

#### Blue whiting
```{r,  fig.width=9, fig.height=8}
plist$Blue_whiting
```

#### Saithe
```{r, fig.width=9, fig.height=8}
plist$Saithe
```

#### Cod
```{r, fig.width=9, fig.height=9}
plist$North_atl_cod
```

#### Haddock
```{r, fig.width=9, fig.height=9}
plist$Haddock
```

#### Greenland halibut
```{r, fig.width=9, fig.height=9}
plist$Green_halibut
```

#### Herring
```{r, fig.width=9, fig.height=8}
plist$Norwegian_ssh
```

#### Redfish
```{r, fig.width=9, fig.height=8}
plist$Redfish
```

#### Mackerel
```{r, fig.width=9, fig.height=8}
plist$Mackerel
```

#### Long rough dab
```{r, fig.width=9, fig.height=9}
plist$Long_rough_dab
```

#### Polar cod
```{r, fig.width=9, fig.height=8}
plist$Polar_cod
```

### {-}

### Interactions among these species

Do our selected species eat each other? What proportion of each species diet comes from species in our selected group?

This table shows the proportion of diet for each species and age class where only our selected species are considered as prey. The statistics are across all time steps in this model run, and *do not* include timesteps where the diet composition was 0.


```{r prop-in-group}

prop <- ms_diet %>%
  filter(prey %in% unique(species)) %>%
  select(species, agecl, time.days, prey, atoutput) %>%
  group_by(species, agecl, time.days) %>%
  summarise(mspreyprop = sum(atoutput)) #sum over prey each timestep
  
range <- prop %>%
  group_by(species, agecl) %>%
  summarise(minprop = min(mspreyprop),
         medprop = median(mspreyprop),
         meanprop = mean(mspreyprop),
         maxprop = max(mspreyprop))

#knitr::kable(range)
library(DT)
datatable(range, rownames = FALSE, options = list(pageLength = 25))

```

Mature age classes of cod and redfish average over a third of their diet compositions from other species in the selected group, suggesting fairly strong predation interactions. 

Many of the selected species share zooplankton prey, so there may be species interactions via prey as well. 

## Generating the dataset 
*(PLACEHOLDER; not done yet June 19 2020)*

Now to get a range of data:

### Config files

`NOBA2config.R` looks like this (adjusted from Alfonso's original):

```{r, code = readLines("./config/NOBA2Config.R"), eval=F}
```

`omdimensions.R` standardizes timesteps, etc. (this is part of atlantisom and should not need to be changed by the user):

```{r, code = readLines("./config/omdimensions.R"), eval=F}
```

`mssurvey_spring.R` and `mssurvey_fall.R` configure the fishery independent surveys:

```{r, code = readLines("./config/mssurvey_spring.R"), eval=F}
```

```{r, code = readLines("./config/mssurvey_fall.R"), eval=F}
```

`msfishery.R` configures the fishery dependent data:

```{r, code = readLines("./config/msfishery.R"), eval=F}
```

### Using the wrappers (now updated for annual age)

All the config files go in the config folder and we'll try running this:

```{r full-test, message=FALSE, warning=FALSE, eval=FALSE}

NOBAom <- om_init(here("config/NOBA2config.R"))

NOBAom_ms <- om_species(sppsubset$Name, NOBAom)

NOBAom_ms_ind <- om_index(usersurvey = here("config/mssurvey.R"), 
                           userfishery = here("config/msfishery.R"),
                           omlist_ss = NOBAom_ms, 
                           n_reps = 1, 
                           save = TRUE)

NOBAom_ms_comp <- om_comps(usersurvey = here("config/mssurvey.R"), 
                           userfishery = here("config/msfishery.R"),
                           omlist_ss = NOBAom_ms, 
                           n_reps = 1, 
                           save = TRUE)


```

### Wrapper test results {.tabset}

#### Biomass index
```{r bioind-1, eval=FALSE}

omlist_ss <- NOBAom_cod
source(here("config/omdimensions.R"))

#read time series data
survObsBiom <- readRDS(file.path(d.name, paste0(scenario.name, "surveyB.rds")))

survObsBiom <- survObsBiom[[1]]

plotB <-ggplot() +
  geom_line(data=survObsBiom, aes(x=time/stepperyr,y=atoutput, color="survey Biomass"), 
            alpha = 10/10) +
  theme_tufte() +
  theme(legend.position = "top") +
  labs(colour=scenario.name)

plotB +
  facet_wrap(~species, scales="free") 

```


#### Catch time series
```{r catchind-1, eval=FALSE}
#read time series data
catchbio_ss <- readRDS(file.path(d.name, paste0(scenario.name, "fishCatch.rds")))

catchbio_ss <- catchbio_ss[[1]]

plotC <-ggplot() +
  geom_line(data=catchbio_ss, aes(x=time/365,y=atoutput, color="observed Catch"), 
            alpha = 10/10) +
  theme_tufte() +
  theme(legend.position = "top") +
  labs(colour=scenario.name)

plotC +
  facet_wrap(~species, scales="free") 


```


#### Survey length composition
```{r lencomp-1, eval=FALSE}

#length comps
len_comp_data <- readRDS(file.path(d.name, paste0(scenario.name, "survObsLenComp.rds")))
fish_len_comp_data <- readRDS(file.path(d.name, paste0(scenario.name, "fishObsLenComp.rds")))

len_comp_data <- len_comp_data[[1]]
fish_len_comp_data <- fish_len_comp_data[[1]]

#add this to om_indices function so that this has years when read in
fish_len_comp_data$time <- as.integer(floor(fish_len_comp_data$time/fstepperyr))

len <- filter(len_comp_data, time %in% c(55:175))

  lfplot <- ggplot(len, aes(upper.bins)) +
    geom_bar(aes(weight = atoutput)) +
    theme_tufte() +
    labs(subtitle = paste(scenario.name,
                          len$species))
  
  lfplot + facet_wrap(~time/stepperyr, ncol=6, scales="free_y")


```


#### Survey age composition (age classes)
```{r agecomp-1, eval=FALSE}

#read in comp data
age_comp_data <- readRDS(file.path(d.name, paste0(scenario.name, "survObsAgeComp.rds")))
age_comp_data <- age_comp_data[[1]]

Natage <- filter(age_comp_data, time %in% c(150:270))

Natageplot <- ggplot(Natage, aes(x=agecl, y=atoutput)) +
    geom_point() +
    theme_tufte() +
    labs(subtitle = paste(scenario.name,
                          Natage$species))
  
  Natageplot + facet_wrap(~time/stepperyr, ncol=6, scales="free_y")
```


#### Survey weight at age (age classes)
```{r wtageclass-1, eval=FALSE}

wtage <- readRDS(file.path(d.name, paste0(scenario.name, "survObsWtAtAge.rds")))
wtage <- wtage[[1]]

wageplot <- ggplot(wtage, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (5 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year sample"))

wageplot + facet_wrap(c("species"), scales="free_y")
```


#### Fishery age composition (age classes)
```{r fishagecomp-1, eval=FALSE}

#read in comp data
fish_age_comp <- readRDS(file.path(d.name, paste0(scenario.name, "fishObsAgeComp.rds")))
fish_age_comp <- fish_age_comp[[1]]

#add this to om_indices function so that this has years when read in
fish_age_comp$time <- fish_age_comp$time/fstepperyr

Natage <- filter(fish_age_comp, time %in% c(30:53))

Natageplot <- ggplot(Natage, aes(x=agecl, y=atoutput)) +
    geom_point() +
    theme_tufte() +
    labs(subtitle = paste(scenario.name,
                          Natage$species))
  
  Natageplot + facet_wrap(~time, ncol=6, scales="free_y")
```

### {-}

Wrappers still work for NOBA cod using standard age classes. 

Visualize new annual age output for numbers at age, catch at age, and weight at age (interpolated): 

### Wrapper test results for annual ages {.tabset #annageoutput}

#### Survey age composition (annual ages)
```{r plot-annagecomp, eval=FALSE}
#read in comp data
annage_comp_data <- readRDS(file.path(d.name, paste0(scenario.name, "survObsFullAgeComp.rds")))
annage_comp_data <- annage_comp_data[[1]]

#fish_age_comp <- readRDS(file.path(d.name, paste0(scenario.name, "fishObsAgeComp.rds")))
#fish_age_comp <- fish_age_comp[[1]]

#add this to om_indices function so that this has years when read in
#fish_age_comp$time <- as.integer(floor(fish_age_comp$time/fstepperyr))

Natage <- filter(annage_comp_data, time %in% c(150:270))

Natageplot <- ggplot(Natage, aes(x=agecl, y=atoutput)) +
    geom_point() +
    theme_tufte() +
    labs(subtitle = paste(scenario.name,
                          Natage$species))
  
  Natageplot + facet_wrap(~time/stepperyr, ncol=6, scales="free_y")
```

#### Survey iterpolated weight at age (annual ages) 
```{r plot-annwtage, eval=FALSE}

wtage <- readRDS(file.path(d.name, paste0(scenario.name, "survObsFullWtAtAge.rds")))
wtage <- wtage[[1]] #this still has second list component, diagnostic plot
wtage <- wtage[[1]]

wageplot <- ggplot(wtage, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (5 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year sample"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

#### Fishery catch at age (annual ages)
```{r plot-catchagecomp, eval=FALSE}

fish_annage_comp <- readRDS(file.path(d.name, paste0(scenario.name, "fishObsFullAgeComp.rds")))
fish_annage_comp <- fish_annage_comp[[1]]

#add this to om_indices function so that this has years when read in
fish_annage_comp$time <- fish_annage_comp$time/fstepperyr

Catage <- filter(fish_annage_comp, time %in% c(30:53))

Catageplot <- ggplot(Catage, aes(x=agecl, y=atoutput)) +
    geom_point() +
    theme_tufte() +
    labs(subtitle = paste(scenario.name,
                          Catage$species))
  
  Catageplot + facet_wrap(~time, ncol=6, scales="free_y")
```

#### Fishery iterpolated weight at age (annual ages) 
```{r plot-fishannwtage, eval=FALSE}

wtage <- readRDS(file.path(d.name, paste0(scenario.name, "fishObsFullWtAtAge.rds")))
wtage <- wtage[[1]] #this still has second list component, diagnostic plot
wtage <- wtage[[1]]

wageplot <- ggplot(wtage, aes(time, atoutput)) +
  geom_line(aes(colour = factor(agecl))) +
  theme_tufte() +
  theme(legend.position = "bottom") +
  xlab("model timestep (5 per year)") +
  ylab("average individual weight (g)") +
  labs(subtitle = paste0(scenario.name, " annual mid year sample"))

wageplot + facet_wrap(c("species"), scales="free_y")

```

### {-}
